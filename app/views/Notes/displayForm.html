#{extends "main.html" /}
#{set title:"New note" /}
#{set 'moreScripts'}
<script type="text/javascript" charset="utf-8">
	var selectedFriend = null;
	$(function(){
        function submitForm(){
            $el = $('form');
            var note = {};
            note.message = $('#message', $el).val();
            note.when = $('#when', $el).val();
            note.receiver = $('#receiver', $el).val();
            if(selectedFriend) {
            	note.friend = selectedFriend
            }
            if (note.message.length > 1 && note.when.length > 1) {
                $.post("@@{Notes.create}", note, function(data) {
                	window.location = "@@{Notes.created}";
                });
            }
            $el.get(0).reset();
            return false;
        }
        $('form').submit(submitForm);
        $('#send').click(submitForm);
        $('#toMe').click(function() {
        	$('#receiver').hide();
        	$('#receiverCaption').hide();
        	$('#options').hide();
        	$('#noteForm').show('slow');
        });
        $('#toAFriend').click(function() {
       		%{ if(controllers.Auth.getUser().hasFacebookAccess()) { }%
				$.getJSON('@@{Users.getFacebookFriends(session.user)}', function(response, textStatus, xhr) {
					var friends = [];
					var data = [];
					for(var i=0; i<response.length; i++) {
	       				data.push(response[i].name);
	       				friends[response[i].name]=response[i].id;
	       			}
	       			$("#receiver").autocomplete({
			    		minLength: 0,
			    		source: data,
			    		close: function(event, ui) {
			    			selectedFriend = friends[$("#receiver").val()];
			    		}
			    	});
			    	$('#receiver').show();
        			$('#receiverCaption').show();
        			$('#options').hide();
        			$('#noteForm').show('slow');
				});
			%{ } }%
        });
        
        $('#date-picker').datepicker()
				  .datepicker( "setDate" , '${models.Note.getDefaultDate().format(play.Play.configuration.get("datepicker.format"))}' )
				  .datepicker( "option", "dateFormat", '${play.Play.configuration.get("datepicker.format")}');
		
		$('#hour').val('${models.Note.getDefaultDate().format("H")}');
    });
</script>
#{/set}  
<p id="options">Send <a href="#" id="toMe">to me</a> or <a href="#" id="toAFriend">to a friend</a></p>
<form id="noteForm">
	#{ifErrors}
	   <h2>Oops...</h2>
	 
	   #{errors}
	       <li>${error}</li>
	   #{/errors}
	 
	#{/ifErrors}
	
	<p><label for="message">Message</label><br/>
	<textarea id="message">${message}</textarea><br/>
	<label for="when">When</label>
	<div id="when">
		<div id="date-picker"></div>
		<label for="hour">at</label>
		<select id="hour">
			<option value="0">12:00 am</option>
	        <option value="1">1:00 am</option>
	        <option value="2">2:00 am</option>
	        <option value="3">3:00 am</option>
	        <option value="4">4:00 am</option>
	        <option value="5">5:00 am</option>
	        <option value="6">6:00 am</option>
	        <option value="7">7:00 am</option>
	        <option value="8">8:00 am</option>
	        <option value="9">9:00 am</option>
	        <option value="10">10:00 am</option>
	        <option value="11">11:00 am</option>
	        <option value="12">12:00 pm</option>
	        <option value="13">1:00 pm</option>
	        <option value="14">2:00 pm</option>
	        <option value="15">3:00 pm</option>
	        <option value="16">4:00 pm</option>
	        <option value="17">5:00 pm</option>
	        <option value="18">6:00 pm</option>
	        <option value="19">7:00 pm</option>
	        <option value="20">8:00 pm</option>
	        <option value="21">9:00 pm</option>
	        <option value="22">10:00 pm</option>
	        <option value="23">11:00 pm</option>
	    </select>
	<label for="location">in</label>
	<input type="text" id="location"/>
	
	<input type="hidden" name="date" id="date"/><br/>
	</div>	
	<label for="receiver" id="receiverCaption">Receiver</label><br/>
	<input type="text" id="receiver" value="" />
	<br /><br /><input type="button" class="button" id="send" value="Send" /></p>
</form>