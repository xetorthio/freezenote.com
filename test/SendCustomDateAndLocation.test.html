#{fixture delete:'all' /}

%{
	def today = new org.joda.time.DateTime();
	def date = today.plusMonths(1).withZoneRetainFields(org.joda.time.DateTimeZone.forID('Europe/London')).toMutableDateTime()
	date.setMinuteOfHour(0)
}%

#{selenium}
	clearSession()

	open('/fakeLogin?user=test@test.com')
    open('/notes/new')
    waitForCondition('selenium.browserbot.getCurrentWindow().jQuery.active == 0', 30000)
    
	click('id=toMe')
	
	waitForElementPresent('id=when')
	select('id=when', 'value=other')
	
	waitForElementPresent('id=location')
    
    type('id=message', 'The owls are not what they seem')
    type('id=location', 'london')
    typeKeys('id=location', 'n')
    
    waitForTextPresent('London, United Kingdom')
    
    mouseOver('//html/body/ul/li/a[. = "London, United Kingdom"]')
    click('//html/body/ul/li/a[. = "London, United Kingdom"]')
    
    clickAndWait('id=send')

    assertTitle(messages.get('created.title'))
    
    open('/notes/last')
    
    assertValue('id=message', 'The owls are not what they seem')
    assertValue('id=sender', 'test@test.com')
    assertValue('id=receiver', 'test@test.com')
    assertValue('id=when', ${date.toDate().format()})
    assertValue('id=location', 'London, United Kingdom')
#{/selenium}